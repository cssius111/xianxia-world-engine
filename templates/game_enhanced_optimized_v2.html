<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修仙世界模拟器 - 水墨风传奇</title>
    
    <!-- CSS样式 -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/ink_style.css') }}">
    
    <!-- 预加载重要资源 -->
    <link rel="preload" href="{{ url_for('static', filename='js/game_controller.js') }}" as="script">
    <link rel="preload" href="{{ url_for('static', filename='js/modules/ui_controller.js') }}" as="script">
    
    <meta name="description" content="沉浸式修仙世界模拟器，体验水墨风传奇修仙之旅">
    <meta name="keywords" content="修仙,游戏,模拟器,RPG,中国风">
    <meta name="author" content="修仙世界引擎">
    
    <!-- 社交媒体元数据 -->
    <meta property="og:title" content="修仙世界模拟器">
    <meta property="og:description" content="踏上修仙之路，体验传奇人生">
    <meta property="og:type" content="website">
    
    <!-- 移动设备优化 -->
    <meta name="theme-color" content="#1a1a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body data-new-session="{{ is_new_session|default(false)|string|lower }}" 
      {% if dev_mode %}class="dev-mode"{% endif %}>
    
    <!-- 墨晕过渡效果 -->
    <div class="ink-transition" id="inkTransition"></div>
    
    <!-- 主游戏容器 -->
    <div class="game-container">
        
        <!-- 左侧栏 - 角色信息与功能菜单 -->
        <aside class="sidebar">
            <!-- 角色状态区域 -->
            <div class="character-status">
                <div class="character-name">{{ player.name if player else '无名侠客' }}</div>
                <div class="character-realm">
                    {% if player and player.attributes %}
                        {{ player.attributes.realm_name or '炼气期' }} ({{ player.attributes.realm_progress or 0 }}%)
                    {% else %}
                        炼气期 (0%)
                    {% endif %}
                </div>
                
                <!-- 属性条 -->
                <div class="attribute-bar" data-attribute="health">
                    <div class="attribute-label">
                        气血 
                        <span class="attribute-value">
                            {% if player and player.attributes %}
                                {{ player.attributes.current_health or 100 }} / {{ player.attributes.max_health or 100 }}
                            {% else %}
                                100 / 100
                            {% endif %}
                        </span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 
                            {% if player and player.attributes %}
                                {{ ((player.attributes.current_health or 100) / (player.attributes.max_health or 100) * 100) | round }}%
                            {% else %}
                                100%
                            {% endif %}
                        "></div>
                    </div>
                </div>
                
                <div class="attribute-bar" data-attribute="mana">
                    <div class="attribute-label">
                        灵力 
                        <span class="attribute-value">
                            {% if player and player.attributes %}
                                {{ player.attributes.current_mana or 50 }} / {{ player.attributes.max_mana or 50 }}
                            {% else %}
                                50 / 50
                            {% endif %}
                        </span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 
                            {% if player and player.attributes %}
                                {{ ((player.attributes.current_mana or 50) / (player.attributes.max_mana or 50) * 100) | round }}%
                            {% else %}
                                100%
                            {% endif %}
                        "></div>
                    </div>
                </div>
                
                <div class="attribute-bar" data-attribute="stamina">
                    <div class="attribute-label">
                        体力 
                        <span class="attribute-value">
                            {% if player and player.attributes %}
                                {{ player.attributes.current_stamina or 100 }} / {{ player.attributes.max_stamina or 100 }}
                            {% else %}
                                100 / 100
                            {% endif %}
                        </span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 
                            {% if player and player.attributes %}
                                {{ ((player.attributes.current_stamina or 100) / (player.attributes.max_stamina or 100) * 100) | round }}%
                            {% else %}
                                100%
                            {% endif %}
                        "></div>
                    </div>
                </div>
                
                <div class="attribute-bar" data-attribute="cultivation">
                    <div class="attribute-label">
                        修为 
                        <span class="attribute-value">
                            {% if player and player.attributes %}
                                {{ player.attributes.cultivation_level or 0 }} / {{ player.attributes.max_cultivation or 100 }}
                            {% else %}
                                0 / 100
                            {% endif %}
                        </span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 
                            {% if player and player.attributes %}
                                {{ ((player.attributes.cultivation_level or 0) / (player.attributes.max_cultivation or 100) * 100) | round }}%
                            {% else %}
                                0%
                            {% endif %}
                        "></div>
                    </div>
                </div>
            </div>
            
            <!-- 功能菜单 - 三列布局 -->
            <nav class="function-menu">
                <a href="#" class="menu-item" data-action="查看状态" title="查看详细角色信息">
                    查看<br>状态
                </a>
                <a href="#" class="menu-item" data-action="查看背包" title="管理物品和装备">
                    查看<br>背包
                </a>
                <a href="#" class="menu-item" data-action="修炼系统" title="进行修炼提升境界">
                    修炼<br>系统
                </a>
                <a href="#" class="menu-item" data-action="成就系统" title="查看获得的成就">
                    成就<br>系统
                </a>
                <a href="#" class="menu-item" data-action="进行探索" title="探索未知区域">
                    进行<br>探索
                </a>
                <a href="#" class="menu-item" data-action="地图系统" title="查看世界地图">
                    地图<br>系统
                </a>
                <a href="#" class="menu-item" data-action="当前任务" title="查看进行中的任务">
                    当前<br>任务
                </a>
                <a href="#" class="menu-item" data-action="保存加载" title="保存或加载游戏">
                    保存<br>加载
                </a>
                <a href="#" class="menu-item" data-action="帮助文档" title="查看游戏帮助">
                    帮助<br>文档
                </a>
            </nav>
        </aside>
        
        <!-- 主内容区域 -->
        <main class="main-content">
            <!-- 游戏输出区域 -->
            <div class="game-output" id="gameOutput">
                <div class="game-log" id="gameLog">
                    <!-- 游戏日志将在这里显示 -->
                    {% if not is_new_session %}
                        <div class="log-entry system-output">欢迎回到修仙世界！</div>
                    {% endif %}
                </div>
            </div>
            
            <!-- 命令输入区域 -->
            <div class="input-area">
                <form class="input-form" id="commandForm">
                    <input type="text" 
                           class="command-input" 
                           id="commandInput"
                           placeholder="输入命令开始你的修仙之旅... (试试：探索、修炼、查看状态)"
                           autocomplete="off"
                           spellcheck="false">
                    <button type="submit" class="submit-button">发送</button>
                </form>
            </div>
        </main>
    </div>
    
    <!-- 游戏状态数据 (隐藏) -->
    <script type="application/json" id="gameData">
    {
        "player": {{ player | tojson if player else '{}' }},
        "location": {{ location | tojson if location else '\"青云城\"' }},
        "buffs": {{ buffs | tojson if buffs else '[]' }},
        "specialStatus": {{ special_status | tojson if special_status else '[]' }},
        "isNewSession": {{ is_new_session | tojson if is_new_session else 'false' }},
        "devMode": {{ dev_mode | tojson if dev_mode else 'false' }}
    }
    </script>
    
    <!-- JavaScript模块加载 -->
    <script>
        // 全局配置
        window.XIANXIA_CONFIG = {
            debug: {{ dev_mode | tojson if dev_mode else 'false' }},
            version: '2.0.0',
            apiBase: '',
            audioEnabled: true,
            autoSave: true
        };
        
        // 错误处理
        window.addEventListener('error', function(e) {
            console.error('全局错误:', e.error);
            
            // 在开发模式下显示详细错误
            if (window.XIANXIA_CONFIG.debug) {
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed; top: 10px; right: 10px; z-index: 10000;
                    background: #ff4444; color: white; padding: 10px;
                    border-radius: 4px; max-width: 300px; font-size: 12px;
                `;
                errorDiv.textContent = `错误: ${e.error.message}`;
                document.body.appendChild(errorDiv);
                
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.parentNode.removeChild(errorDiv);
                    }
                }, 5000);
            }
        });
    </script>
    
    <!-- 核心JavaScript文件 -->
    <script src="{{ url_for('static', filename='js/game_controller.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/ui_controller.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/audio_controller.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/player_profile.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/modal_controller.js') }}"></script>
    
    <!-- 游戏初始化脚本 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎮 修仙世界模拟器启动完成');
            
            // 显示启动完成消息
            if (window.XianxiaGame && window.XianxiaGame.modules.ui) {
                setTimeout(() => {
                    window.XianxiaGame.modules.ui.addLogEntry('✨ 系统初始化完成，开始你的修仙之旅吧！', 'system-output special-event');
                }, 1000);
            }
            
            {% if dev_mode %}
            // 开发模式提示
            console.log('🔧 开发模式已启用');
            console.log('💡 可用调试命令:');
            console.log('   - XWE_DEBUG.getState() - 获取游戏状态');
            console.log('   - XWE_DEBUG.exportSave() - 导出存档');
            console.log('   - XWE_DEBUG.clearLogs() - 清空日志');
            {% endif %}
        });
        
        // 页面卸载前的提示
        window.addEventListener('beforeunload', function(e) {
            if (window.XianxiaGame && window.XianxiaGame.gameState.isPlaying) {
                const message = '游戏正在进行中，确定要离开吗？未保存的进度可能会丢失。';
                e.returnValue = message;
                return message;
            }
        });
        
        // 性能监控 (仅开发模式)
        {% if dev_mode %}
        if ('performance' in window) {
            window.addEventListener('load', function() {
                setTimeout(() => {
                    const perfData = performance.getEntriesByType('navigation')[0];
                    console.log('📊 页面加载性能:', {
                        domContentLoaded: Math.round(perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart),
                        loadComplete: Math.round(perfData.loadEventEnd - perfData.loadEventStart),
                        totalTime: Math.round(perfData.loadEventEnd - perfData.navigationStart)
                    });
                }, 0);
            });
        }
        {% endif %}
    </script>
    
    <!-- 服务工作者注册 (用于缓存) -->
    <script>
        if ('serviceWorker' in navigator && !window.XIANXIA_CONFIG.debug) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('📱 服务工作者注册成功:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('📱 服务工作者注册失败:', error);
                    });
            });
        }
    </script>
    
    <!-- 谷歌分析 (如果需要) -->
    {% if not dev_mode %}
    <!-- 可以在这里添加分析代码 -->
    {% endif %}
    
</body>
</html>