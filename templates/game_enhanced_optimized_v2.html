<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®ä»™ä¸–ç•Œæ¨¡æ‹Ÿå™¨ - æ°´å¢¨é£ä¼ å¥‡</title>
    
    <!-- CSSæ ·å¼ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/ink_style.css') }}">
    
    <!-- é¢„åŠ è½½é‡è¦èµ„æº -->
    <link rel="preload" href="{{ url_for('static', filename='js/game_controller.js') }}" as="script">
    <link rel="preload" href="{{ url_for('static', filename='js/modules/ui_controller.js') }}" as="script">
    
    <meta name="description" content="æ²‰æµ¸å¼ä¿®ä»™ä¸–ç•Œæ¨¡æ‹Ÿå™¨ï¼Œä½“éªŒæ°´å¢¨é£ä¼ å¥‡ä¿®ä»™ä¹‹æ—…">
    <meta name="keywords" content="ä¿®ä»™,æ¸¸æˆ,æ¨¡æ‹Ÿå™¨,RPG,ä¸­å›½é£">
    <meta name="author" content="ä¿®ä»™ä¸–ç•Œå¼•æ“">
    
    <!-- ç¤¾äº¤åª’ä½“å…ƒæ•°æ® -->
    <meta property="og:title" content="ä¿®ä»™ä¸–ç•Œæ¨¡æ‹Ÿå™¨">
    <meta property="og:description" content="è¸ä¸Šä¿®ä»™ä¹‹è·¯ï¼Œä½“éªŒä¼ å¥‡äººç”Ÿ">
    <meta property="og:type" content="website">
    
    <!-- ç§»åŠ¨è®¾å¤‡ä¼˜åŒ– -->
    <meta name="theme-color" content="#1a1a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body data-new-session="{{ is_new_session|default(false)|string|lower }}" 
      {% if dev_mode %}class="dev-mode"{% endif %}>
    
    <!-- å¢¨æ™•è¿‡æ¸¡æ•ˆæœ -->
    <div class="ink-transition" id="inkTransition"></div>
    
    <!-- ä¸»æ¸¸æˆå®¹å™¨ -->
    <div class="game-container">
        
        <!-- å·¦ä¾§æ  - è§’è‰²ä¿¡æ¯ä¸åŠŸèƒ½èœå• -->
        <aside class="sidebar">
            <!-- è§’è‰²çŠ¶æ€åŒºåŸŸ -->
            <div class="character-status">
                <div class="character-name">{{ player.name if player else 'æ— åä¾ å®¢' }}</div>
                <div class="character-realm">
                    {% if player and player.attributes %}
                        {{ player.attributes.realm_name or 'ç‚¼æ°”æœŸ' }} ({{ player.attributes.realm_progress or 0 }}%)
                    {% else %}
                        ç‚¼æ°”æœŸ (0%)
                    {% endif %}
                </div>
                
                <!-- å±æ€§æ¡ -->
                <div class="attribute-bar" data-attribute="health">
                    <div class="attribute-label">
                        æ°”è¡€ 
                        <span class="attribute-value">
                            {% if player and player.attributes %}
                                {{ player.attributes.current_health or 100 }} / {{ player.attributes.max_health or 100 }}
                            {% else %}
                                100 / 100
                            {% endif %}
                        </span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 
                            {% if player and player.attributes %}
                                {{ ((player.attributes.current_health or 100) / (player.attributes.max_health or 100) * 100) | round }}%
                            {% else %}
                                100%
                            {% endif %}
                        "></div>
                    </div>
                </div>
                
                <div class="attribute-bar" data-attribute="mana">
                    <div class="attribute-label">
                        çµåŠ› 
                        <span class="attribute-value">
                            {% if player and player.attributes %}
                                {{ player.attributes.current_mana or 50 }} / {{ player.attributes.max_mana or 50 }}
                            {% else %}
                                50 / 50
                            {% endif %}
                        </span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 
                            {% if player and player.attributes %}
                                {{ ((player.attributes.current_mana or 50) / (player.attributes.max_mana or 50) * 100) | round }}%
                            {% else %}
                                100%
                            {% endif %}
                        "></div>
                    </div>
                </div>
                
                <div class="attribute-bar" data-attribute="stamina">
                    <div class="attribute-label">
                        ä½“åŠ› 
                        <span class="attribute-value">
                            {% if player and player.attributes %}
                                {{ player.attributes.current_stamina or 100 }} / {{ player.attributes.max_stamina or 100 }}
                            {% else %}
                                100 / 100
                            {% endif %}
                        </span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 
                            {% if player and player.attributes %}
                                {{ ((player.attributes.current_stamina or 100) / (player.attributes.max_stamina or 100) * 100) | round }}%
                            {% else %}
                                100%
                            {% endif %}
                        "></div>
                    </div>
                </div>
                
                <div class="attribute-bar" data-attribute="cultivation">
                    <div class="attribute-label">
                        ä¿®ä¸º 
                        <span class="attribute-value">
                            {% if player and player.attributes %}
                                {{ player.attributes.cultivation_level or 0 }} / {{ player.attributes.max_cultivation or 100 }}
                            {% else %}
                                0 / 100
                            {% endif %}
                        </span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 
                            {% if player and player.attributes %}
                                {{ ((player.attributes.cultivation_level or 0) / (player.attributes.max_cultivation or 100) * 100) | round }}%
                            {% else %}
                                0%
                            {% endif %}
                        "></div>
                    </div>
                </div>
            </div>
            
            <!-- åŠŸèƒ½èœå• - ä¸‰åˆ—å¸ƒå±€ -->
            <nav class="function-menu">
                <a href="#" class="menu-item" data-action="æŸ¥çœ‹çŠ¶æ€" title="æŸ¥çœ‹è¯¦ç»†è§’è‰²ä¿¡æ¯">
                    æŸ¥çœ‹<br>çŠ¶æ€
                </a>
                <a href="#" class="menu-item" data-action="æŸ¥çœ‹èƒŒåŒ…" title="ç®¡ç†ç‰©å“å’Œè£…å¤‡">
                    æŸ¥çœ‹<br>èƒŒåŒ…
                </a>
                <a href="#" class="menu-item" data-action="ä¿®ç‚¼ç³»ç»Ÿ" title="è¿›è¡Œä¿®ç‚¼æå‡å¢ƒç•Œ">
                    ä¿®ç‚¼<br>ç³»ç»Ÿ
                </a>
                <a href="#" class="menu-item" data-action="æˆå°±ç³»ç»Ÿ" title="æŸ¥çœ‹è·å¾—çš„æˆå°±">
                    æˆå°±<br>ç³»ç»Ÿ
                </a>
                <a href="#" class="menu-item" data-action="è¿›è¡Œæ¢ç´¢" title="æ¢ç´¢æœªçŸ¥åŒºåŸŸ">
                    è¿›è¡Œ<br>æ¢ç´¢
                </a>
                <a href="#" class="menu-item" data-action="åœ°å›¾ç³»ç»Ÿ" title="æŸ¥çœ‹ä¸–ç•Œåœ°å›¾">
                    åœ°å›¾<br>ç³»ç»Ÿ
                </a>
                <a href="#" class="menu-item" data-action="å½“å‰ä»»åŠ¡" title="æŸ¥çœ‹è¿›è¡Œä¸­çš„ä»»åŠ¡">
                    å½“å‰<br>ä»»åŠ¡
                </a>
                <a href="#" class="menu-item" data-action="ä¿å­˜åŠ è½½" title="ä¿å­˜æˆ–åŠ è½½æ¸¸æˆ">
                    ä¿å­˜<br>åŠ è½½
                </a>
                <a href="#" class="menu-item" data-action="å¸®åŠ©æ–‡æ¡£" title="æŸ¥çœ‹æ¸¸æˆå¸®åŠ©">
                    å¸®åŠ©<br>æ–‡æ¡£
                </a>
            </nav>
        </aside>
        
        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <!-- æ¸¸æˆè¾“å‡ºåŒºåŸŸ -->
            <div class="game-output" id="gameOutput">
                <div class="game-log" id="gameLog">
                    <!-- æ¸¸æˆæ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    {% if not is_new_session %}
                        <div class="log-entry system-output">æ¬¢è¿å›åˆ°ä¿®ä»™ä¸–ç•Œï¼</div>
                    {% endif %}
                </div>
            </div>
            
            <!-- å‘½ä»¤è¾“å…¥åŒºåŸŸ -->
            <div class="input-area">
                <form class="input-form" id="commandForm">
                    <input type="text" 
                           class="command-input" 
                           id="commandInput"
                           placeholder="è¾“å…¥å‘½ä»¤å¼€å§‹ä½ çš„ä¿®ä»™ä¹‹æ—…... (è¯•è¯•ï¼šæ¢ç´¢ã€ä¿®ç‚¼ã€æŸ¥çœ‹çŠ¶æ€)"
                           autocomplete="off"
                           spellcheck="false">
                    <button type="submit" class="submit-button">å‘é€</button>
                </form>
            </div>
        </main>
    </div>
    
    <!-- æ¸¸æˆçŠ¶æ€æ•°æ® (éšè—) -->
    <script type="application/json" id="gameData">
    {
        "player": {{ player | tojson if player else '{}' }},
        "location": {{ location | tojson if location else '\"é’äº‘åŸ\"' }},
        "buffs": {{ buffs | tojson if buffs else '[]' }},
        "specialStatus": {{ special_status | tojson if special_status else '[]' }},
        "isNewSession": {{ is_new_session | tojson if is_new_session else 'false' }},
        "devMode": {{ dev_mode | tojson if dev_mode else 'false' }}
    }
    </script>
    
    <!-- JavaScriptæ¨¡å—åŠ è½½ -->
    <script>
        // å…¨å±€é…ç½®
        window.XIANXIA_CONFIG = {
            debug: {{ dev_mode | tojson if dev_mode else 'false' }},
            version: '2.0.0',
            apiBase: '',
            audioEnabled: true,
            autoSave: true
        };
        
        // é”™è¯¯å¤„ç†
        window.addEventListener('error', function(e) {
            console.error('å…¨å±€é”™è¯¯:', e.error);
            
            // åœ¨å¼€å‘æ¨¡å¼ä¸‹æ˜¾ç¤ºè¯¦ç»†é”™è¯¯
            if (window.XIANXIA_CONFIG.debug) {
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed; top: 10px; right: 10px; z-index: 10000;
                    background: #ff4444; color: white; padding: 10px;
                    border-radius: 4px; max-width: 300px; font-size: 12px;
                `;
                errorDiv.textContent = `é”™è¯¯: ${e.error.message}`;
                document.body.appendChild(errorDiv);
                
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.parentNode.removeChild(errorDiv);
                    }
                }, 5000);
            }
        });
    </script>
    
    <!-- æ ¸å¿ƒJavaScriptæ–‡ä»¶ -->
    <script src="{{ url_for('static', filename='js/game_controller.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/ui_controller.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/audio_controller.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/player_profile.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/modal_controller.js') }}"></script>
    
    <!-- æ¸¸æˆåˆå§‹åŒ–è„šæœ¬ -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ® ä¿®ä»™ä¸–ç•Œæ¨¡æ‹Ÿå™¨å¯åŠ¨å®Œæˆ');
            
            // æ˜¾ç¤ºå¯åŠ¨å®Œæˆæ¶ˆæ¯
            if (window.XianxiaGame && window.XianxiaGame.modules.ui) {
                setTimeout(() => {
                    window.XianxiaGame.modules.ui.addLogEntry('âœ¨ ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œå¼€å§‹ä½ çš„ä¿®ä»™ä¹‹æ—…å§ï¼', 'system-output special-event');
                }, 1000);
            }
            
            {% if dev_mode %}
            // å¼€å‘æ¨¡å¼æç¤º
            console.log('ğŸ”§ å¼€å‘æ¨¡å¼å·²å¯ç”¨');
            console.log('ğŸ’¡ å¯ç”¨è°ƒè¯•å‘½ä»¤:');
            console.log('   - XWE_DEBUG.getState() - è·å–æ¸¸æˆçŠ¶æ€');
            console.log('   - XWE_DEBUG.exportSave() - å¯¼å‡ºå­˜æ¡£');
            console.log('   - XWE_DEBUG.clearLogs() - æ¸…ç©ºæ—¥å¿—');
            {% endif %}
        });
        
        // é¡µé¢å¸è½½å‰çš„æç¤º
        window.addEventListener('beforeunload', function(e) {
            if (window.XianxiaGame && window.XianxiaGame.gameState.isPlaying) {
                const message = 'æ¸¸æˆæ­£åœ¨è¿›è¡Œä¸­ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿæœªä¿å­˜çš„è¿›åº¦å¯èƒ½ä¼šä¸¢å¤±ã€‚';
                e.returnValue = message;
                return message;
            }
        });
        
        // æ€§èƒ½ç›‘æ§ (ä»…å¼€å‘æ¨¡å¼)
        {% if dev_mode %}
        if ('performance' in window) {
            window.addEventListener('load', function() {
                setTimeout(() => {
                    const perfData = performance.getEntriesByType('navigation')[0];
                    console.log('ğŸ“Š é¡µé¢åŠ è½½æ€§èƒ½:', {
                        domContentLoaded: Math.round(perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart),
                        loadComplete: Math.round(perfData.loadEventEnd - perfData.loadEventStart),
                        totalTime: Math.round(perfData.loadEventEnd - perfData.navigationStart)
                    });
                }, 0);
            });
        }
        {% endif %}
    </script>
    
    <!-- æœåŠ¡å·¥ä½œè€…æ³¨å†Œ (ç”¨äºç¼“å­˜) -->
    <script>
        if ('serviceWorker' in navigator && !window.XIANXIA_CONFIG.debug) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('ğŸ“± æœåŠ¡å·¥ä½œè€…æ³¨å†ŒæˆåŠŸ:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('ğŸ“± æœåŠ¡å·¥ä½œè€…æ³¨å†Œå¤±è´¥:', error);
                    });
            });
        }
    </script>
    
    <!-- è°·æ­Œåˆ†æ (å¦‚æœéœ€è¦) -->
    {% if not dev_mode %}
    <!-- å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ åˆ†æä»£ç  -->
    {% endif %}
    
</body>
</html>