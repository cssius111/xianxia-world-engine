<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§’è‰²åˆ›å»º - ä¿®ä»™ä¸–ç•Œæ¨¡æ‹Ÿå™¨</title>
    
    <!-- CSSæ ·å¼ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/ink_style.css') }}">
    
    <!-- ç½‘ç«™å›¾æ ‡ -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    
    <style>
        /* è§’è‰²åˆ›å»ºä¸“ç”¨æ ·å¼ */
        .creation-container {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--paper-cream) 0%, var(--paper-white) 100%);
            padding: 20px;
        }
        
        .creation-progress {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .progress-step {
            display: flex;
            align-items: center;
            margin: 0 10px;
            font-size: 0.9rem;
            color: var(--ink-lighter);
        }
        
        .progress-step.active {
            color: var(--brush-gold);
            font-weight: bold;
        }
        
        .progress-step.completed {
            color: var(--bamboo-green);
        }
        
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--cloud-gray);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            font-weight: bold;
        }
        
        .progress-step.active .step-number {
            background: var(--brush-gold);
        }
        
        .progress-step.completed .step-number {
            background: var(--bamboo-green);
        }
        
        .attribute-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .attribute-card {
            background: rgba(212, 175, 55, 0.1);
            border: 2px solid var(--brush-gold);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all var(--transition-fast);
        }
        
        .attribute-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
        }
        
        .attribute-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--ink-black);
            margin-bottom: 10px;
        }
        
        .attribute-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--brush-gold);
            margin-bottom: 10px;
        }
        
        .attribute-description {
            font-size: 0.9rem;
            color: var(--ink-lighter);
            line-height: 1.4;
        }
        
        .character-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .character-type-card {
            border: 2px solid var(--ink-lighter);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            background: var(--paper-white);
        }
        
        .character-type-card:hover {
            border-color: var(--brush-gold);
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }
        
        .character-type-card.selected {
            border-color: var(--brush-gold);
            background: rgba(212, 175, 55, 0.1);
        }
        
        .type-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .type-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--ink-black);
            margin-bottom: 10px;
        }
        
        .type-description {
            color: var(--ink-lighter);
            line-height: 1.4;
            margin-bottom: 15px;
        }
        
        .type-benefits {
            font-size: 0.85rem;
            color: var(--bamboo-green);
        }
        
        .roll-section {
            text-align: center;
            margin: 30px 0;
        }
        
        .roll-button {
            background: linear-gradient(135deg, var(--mountain-blue) 0%, #5a9fd4 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all var(--transition-fast);
            margin: 10px;
        }
        
        .roll-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .roll-button:active {
            transform: translateY(0);
        }
        
        .roll-button.auto-roll {
            background: linear-gradient(135deg, var(--bamboo-green) 0%, #6fa85a 100%);
        }
        
        .creation-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
        }
        
        .action-button {
            padding: 15px 30px;
            border: 2px solid var(--brush-gold);
            border-radius: 8px;
            background: var(--paper-white);
            color: var(--ink-black);
            text-decoration: none;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all var(--transition-fast);
            cursor: pointer;
        }
        
        .action-button:hover {
            background: rgba(212, 175, 55, 0.1);
            transform: translateY(-2px);
        }
        
        .action-button.primary {
            background: var(--brush-gold);
            color: var(--ink-black);
        }
        
        .action-button.primary:hover {
            background: #f4d03f;
        }
        
        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .story-section {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 12px;
            padding: 25px;
            margin: 30px 0;
            border-left: 4px solid var(--brush-gold);
        }
        
        .story-title {
            font-family: var(--font-title);
            font-size: 1.4rem;
            color: var(--ink-black);
            margin-bottom: 15px;
        }
        
        .story-text {
            line-height: 1.8;
            color: var(--ink-lighter);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
        }
        
        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-content {
            background: var(--paper-white);
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--shadow-strong);
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--cloud-gray);
            border-top: 5px solid var(--brush-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .attribute-grid {
                grid-template-columns: 1fr;
            }
            
            .character-type-grid {
                grid-template-columns: 1fr;
            }
            
            .creation-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .action-button {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- å¢¨æ™•è¿‡æ¸¡æ•ˆæœ -->
    <div class="ink-transition" id="inkTransition"></div>
    
    <!-- åŠ è½½é®ç½© -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>æ­£åœ¨åˆ›å»ºè§’è‰²...</h3>
            <p>è¯·ç¨å€™ï¼Œç³»ç»Ÿæ­£åœ¨ä¸ºä½ å‡†å¤‡ä¿®ä»™ä¹‹æ—…</p>
        </div>
    </div>
    
    <!-- è§’è‰²åˆ›å»ºå®¹å™¨ -->
    <div class="creation-container">
        <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
        <div class="creation-progress">
            <div class="progress-step active" data-step="1">
                <div class="step-number">1</div>
                <span>é€‰æ‹©ç±»å‹</span>
            </div>
            <div class="progress-step" data-step="2">
                <div class="step-number">2</div>
                <span>éšæœºå±æ€§</span>
            </div>
            <div class="progress-step" data-step="3">
                <div class="step-number">3</div>
                <span>ç¡®è®¤åˆ›å»º</span>
            </div>
        </div>
        
        <!-- æ­¥éª¤1ï¼šé€‰æ‹©è§’è‰²ç±»å‹ -->
        <div class="creation-step" id="step1">
            <div class="creation-title">ğŸ­ é€‰æ‹©ä½ çš„ä¿®ä»™é“é€”</div>
            
            <div class="story-section">
                <div class="story-title">èƒŒæ™¯è®¾å®š</div>
                <div class="story-text">
                    åœ¨è¿™ä¸ªç¥ç§˜çš„ä¿®ä»™ä¸–ç•Œä¸­ï¼Œæ¯ä¸€ä½ä¿®å£«éƒ½æœ‰ç€ä¸åŒçš„ä¿®ç‚¼é“é€”ã€‚
                    æœ‰äººä»¥å‰‘å…¥é“ï¼Œè¿½æ±‚é”‹èŠ’æ¯•éœ²çš„å‰‘æ„ï¼›æœ‰äººç‚¼ä½“ä¿®èº«ï¼Œè¿½æ±‚è‚‰èº«æˆåœ£çš„å¢ƒç•Œï¼›
                    ä¹Ÿæœ‰äººä¸“ç ”æ³•æœ¯ï¼Œä»¥é€šå¤©å½»åœ°çš„ç¥é€šåéœ‡å¤©ä¸‹ã€‚
                    <br><br>
                    é€‰æ‹©ä½ çš„é“é€”ï¼Œè¿™å°†å†³å®šä½ åˆæœŸçš„ä¿®ç‚¼æ–¹å‘å’Œå¤©èµ‹å€¾å‘ã€‚
                    å½“ç„¶ï¼Œåœ¨ä¿®ä»™è·¯ä¸Šï¼Œä¸€åˆ‡çš†æœ‰å¯èƒ½æ”¹å˜...
                </div>
            </div>
            
            <div class="character-type-grid">
                <div class="character-type-card" data-type="sword" onclick="selectCharacterType('sword')">
                    <div class="type-icon">âš”ï¸</div>
                    <div class="type-name">å‰‘ä¿®</div>
                    <div class="type-description">
                        ä»¥å‰‘ä¸ºé“ï¼Œè¿½æ±‚æè‡´çš„æ”»å‡»åŠ›ã€‚
                        å‰‘ä¿®çš„æ”»å‡»å¼ºå¤§ï¼Œä½†é˜²å¾¡ç›¸å¯¹è¾ƒå¼±ã€‚
                    </div>
                    <div class="type-benefits">
                        æ”»å‡»åŠ› +5 | é˜²å¾¡åŠ› -2 | é—¨æ´¾ï¼šå‰‘å®—
                    </div>
                </div>
                
                <div class="character-type-card" data-type="body" onclick="selectCharacterType('body')">
                    <div class="type-icon">ğŸ’ª</div>
                    <div class="type-name">ä½“ä¿®</div>
                    <div class="type-description">
                        ä¸“æ³¨äºè‚‰èº«ä¿®ç‚¼ï¼Œæ‹¥æœ‰å¼ºå¤§çš„é˜²å¾¡åŠ›ã€‚
                        ä½“ä¿®ç”Ÿå­˜èƒ½åŠ›å¼ºï¼Œä½†é€Ÿåº¦è¾ƒæ…¢ã€‚
                    </div>
                    <div class="type-benefits">
                        é˜²å¾¡åŠ› +5 | é€Ÿåº¦ -2 | é—¨æ´¾ï¼šç‚¼ä½“å®—
                    </div>
                </div>
                
                <div class="character-type-card" data-type="magic" onclick="selectCharacterType('magic')">
                    <div class="type-icon">ğŸ”®</div>
                    <div class="type-name">æ³•ä¿®</div>
                    <div class="type-description">
                        ä¸“ç ”æ³•æœ¯ç¥é€šï¼Œæ‹¥æœ‰å¼ºå¤§çš„æ³•åŠ›ã€‚
                        æ³•ä¿®çµåŠ›å……æ²›ï¼Œä½†ä½“è´¨ç›¸å¯¹è„†å¼±ã€‚
                    </div>
                    <div class="type-benefits">
                        çµåŠ› +20 | æ°”è¡€ -10 | é—¨æ´¾ï¼šç„å¤©å®—
                    </div>
                </div>
                
                <div class="character-type-card" data-type="random" onclick="selectCharacterType('random')">
                    <div class="type-icon">ğŸ²</div>
                    <div class="type-name">éšæœºé“é€”</div>
                    <div class="type-description">
                        è®©å‘½è¿å†³å®šä½ çš„é“é€”ï¼
                        éšæœºè·å¾—ä¸€ç§ç±»å‹ï¼Œå¯èƒ½å¾—åˆ°æ„å¤–çš„æƒŠå–œã€‚
                    </div>
                    <div class="type-benefits">
                        éšæœºåŠ æˆ | ç¥ç§˜é—¨æ´¾ | æœªçŸ¥å¤©èµ‹
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ­¥éª¤2ï¼šéšæœºå±æ€§ -->
        <div class="creation-step" id="step2" style="display: none;">
            <div class="creation-title">ğŸ² éšæœºç”Ÿæˆè§’è‰²å±æ€§</div>
            
            <div class="roll-section">
                <p style="color: var(--ink-lighter); margin-bottom: 20px;">
                    ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®éšæœºç”Ÿæˆä½ çš„è§’è‰²å±æ€§ã€‚å¦‚æœä¸æ»¡æ„ï¼Œå¯ä»¥é‡æ–°éšæœºã€‚
                </p>
                
                <button class="roll-button" id="rollButton" onclick="rollAttributes()">
                    ğŸ² æŠ•æ·å‘½è¿éª°å­
                </button>
                
                <button class="roll-button auto-roll" id="autoRollButton" onclick="autoRoll()">
                    âš¡ è‡ªåŠ¨æŠ•æ· (10æ¬¡)
                </button>
            </div>
            
            <div class="attribute-grid" id="attributeDisplay" style="display: none;">
                <div class="attribute-card">
                    <div class="attribute-name">å§“å</div>
                    <div class="attribute-value" id="nameValue">-</div>
                    <div class="attribute-description">ä½ åœ¨è¿™ä¸ªä¸–ç•Œçš„ç§°å‘¼</div>
                </div>
                
                <div class="attribute-card">
                    <div class="attribute-name">å¹´é¾„</div>
                    <div class="attribute-value" id="ageValue">-</div>
                    <div class="attribute-description">å½±å“åˆå§‹ç»éªŒå’Œå¯¿å‘½</div>
                </div>
                
                <div class="attribute-card">
                    <div class="attribute-name">çµæ ¹</div>
                    <div class="attribute-value" id="rootValue">-</div>
                    <div class="attribute-description">å†³å®šä¿®ç‚¼é€Ÿåº¦å’Œä¸Šé™</div>
                </div>
                
                <div class="attribute-card">
                    <div class="attribute-name">æ‚Ÿæ€§</div>
                    <div class="attribute-value" id="comprehensionValue">-</div>
                    <div class="attribute-description">å½±å“æŠ€èƒ½å­¦ä¹ å’Œçªç ´</div>
                </div>
                
                <div class="attribute-card">
                    <div class="attribute-name">æ°”è¿</div>
                    <div class="attribute-value" id="luckValue">-</div>
                    <div class="attribute-description">å½±å“å¥‡é‡å’Œå®ç‰©è·å¾—</div>
                </div>
                
                <div class="attribute-card">
                    <div class="attribute-name">é­…åŠ›</div>
                    <div class="attribute-value" id="charismaValue">-</div>
                    <div class="attribute-description">å½±å“NPCå¥½æ„Ÿå’Œäº¤æ˜“</div>
                </div>
            </div>
        </div>
        
        <!-- æ­¥éª¤3ï¼šç¡®è®¤åˆ›å»º -->
        <div class="creation-step" id="step3" style="display: none;">
            <div class="creation-title">âœ¨ ç¡®è®¤è§’è‰²åˆ›å»º</div>
            
            <div class="story-section">
                <div class="story-title">è§’è‰²é¢„è§ˆ</div>
                <div id="characterSummary">
                    <!-- è§’è‰²æ€»ç»“å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
            
            <div class="story-section">
                <div class="story-title">ä¿®ä»™ä¹‹è·¯çš„å¼€å§‹</div>
                <div class="story-text">
                    å½“ç¬¬ä¸€ç¼•æ™¨å…‰æ´’å‘å¤§åœ°ï¼Œä½ çå¼€äº†åŒçœ¼ã€‚
                    ä½œä¸ºä¸€ååˆå…¥ä¿®ä»™ç•Œçš„æ–°äººï¼Œä½ å³å°†è¸ä¸Šè¿™æ¡å……æ»¡æœºé‡ä¸å±é™©çš„é“è·¯ã€‚
                    <br><br>
                    åœ¨é’äº‘åŸä¸­ï¼Œä½ å°†å¼€å§‹ä½ çš„ä¿®ä»™ä¹‹æ—…ã€‚
                    è®°ä½ï¼šä¿®ä»™è·¯æ¼«æ¼«ï¼Œå”¯æœ‰åšæŒä¸æ‡ˆï¼Œæ–¹èƒ½è¾¾åˆ°é•¿ç”Ÿä¸è€çš„å½¼å²¸ã€‚
                    <br><br>
                    å‡†å¤‡å¥½äº†å—ï¼Ÿä½ çš„ä¼ å¥‡å³å°†å¼€å§‹...
                </div>
            </div>
        </div>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="creation-actions">
            <button class="action-button" id="prevButton" onclick="previousStep()" style="display: none;">
                â† ä¸Šä¸€æ­¥
            </button>
            
            <button class="action-button primary" id="nextButton" onclick="nextStep()" disabled>
                ä¸‹ä¸€æ­¥ â†’
            </button>
            
            <button class="action-button primary" id="createButton" onclick="createCharacter()" style="display: none;">
                ğŸš€ å¼€å§‹ä¿®ä»™ä¹‹æ—…
            </button>
            
            <a href="{{ url_for('welcome') }}" class="action-button">
                â† è¿”å›é¦–é¡µ
            </a>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script>
        // å…¨å±€å˜é‡
        let currentStep = 1;
        let selectedType = null;
        let characterData = {};
        let isDevMode = {{ dev_mode | tojson if dev_mode else 'false' }};
        
        // è§’è‰²åå­—åº“
        const maleNames = ['å¶è¾°', 'è§ç‚', 'æ—åŠ¨', 'çŸ³æ˜Š', 'æ¥šé£', 'ç‹è…¾', 'å¤é’', 'æ…•å®¹å¤', 'ç‹¬å­¤æ±‚è´¥', 'ä»¤ç‹å†²'];
        const femaleNames = ['æ—é’éœ', 'ä¸Šå®˜å©‰å„¿', 'è‹å¦²å·±', 'è²‚è‰', 'ç‹æ˜­å›', 'æ¨ç‰ç¯', 'è¥¿æ–½', 'èµµé£ç‡•', 'èŠ±æœ¨å…°', 'ç©†æ¡‚è‹±'];
        const surnames = ['æ', 'ç‹', 'å¼ ', 'åˆ˜', 'é™ˆ', 'æ¨', 'èµµ', 'é»„', 'å‘¨', 'å´', 'å¾', 'å­™', 'èƒ¡', 'æœ±', 'é«˜', 'æ—', 'ä½•', 'éƒ­', 'é©¬', 'ç½—'];
        
        // çµæ ¹ç±»å‹
        const spiritualRoots = {
            'çº¯é‡‘çµæ ¹': { rarity: 0.001, quality: 'ä¼ è¯´', color: '#FFD700' },
            'çº¯æœ¨çµæ ¹': { rarity: 0.001, quality: 'ä¼ è¯´', color: '#228B22' },
            'çº¯æ°´çµæ ¹': { rarity: 0.001, quality: 'ä¼ è¯´', color: '#4169E1' },
            'çº¯ç«çµæ ¹': { rarity: 0.001, quality: 'ä¼ è¯´', color: '#FF4500' },
            'çº¯åœŸçµæ ¹': { rarity: 0.001, quality: 'ä¼ è¯´', color: '#8B4513' },
            'é›·çµæ ¹': { rarity: 0.0001, quality: 'ç¥è¯', color: '#9400D3' },
            'å†°çµæ ¹': { rarity: 0.0001, quality: 'ç¥è¯', color: '#00FFFF' },
            'é£çµæ ¹': { rarity: 0.0001, quality: 'ç¥è¯', color: '#00FF7F' },
            'é‡‘æ°´çµæ ¹': { rarity: 0.02, quality: 'ç¨€æœ‰', color: '#4682B4' },
            'æœ¨ç«çµæ ¹': { rarity: 0.02, quality: 'ç¨€æœ‰', color: '#FF6347' },
            'ä¸‰å±æ€§çµæ ¹': { rarity: 0.15, quality: 'æ™®é€š', color: '#708090' },
            'å››å±æ€§çµæ ¹': { rarity: 0.25, quality: 'å¸¸è§', color: '#A9A9A9' },
            'äº”è¡Œçµæ ¹': { rarity: 0.35, quality: 'å¾ˆå¸¸è§', color: '#D3D3D3' }
        };
        
        // é€‰æ‹©è§’è‰²ç±»å‹
        function selectCharacterType(type) {
            // ç§»é™¤ä¹‹å‰çš„é€‰æ‹©
            document.querySelectorAll('.character-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // é€‰æ‹©å½“å‰ç±»å‹
            document.querySelector(`[data-type="${type}"]`).classList.add('selected');
            selectedType = type;
            
            // å¯ç”¨ä¸‹ä¸€æ­¥æŒ‰é’®
            document.getElementById('nextButton').disabled = false;
            
            console.log('é€‰æ‹©è§’è‰²ç±»å‹:', type);
        }
        
        // ä¸‹ä¸€æ­¥
        function nextStep() {
            if (currentStep < 3) {
                // éšè—å½“å‰æ­¥éª¤
                document.getElementById(`step${currentStep}`).style.display = 'none';
                
                // æ›´æ–°è¿›åº¦
                document.querySelector(`[data-step="${currentStep}"]`).classList.remove('active');
                document.querySelector(`[data-step="${currentStep}"]`).classList.add('completed');
                
                currentStep++;
                
                // æ˜¾ç¤ºä¸‹ä¸€æ­¥éª¤
                document.getElementById(`step${currentStep}`).style.display = 'block';
                document.querySelector(`[data-step="${currentStep}"]`).classList.add('active');
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                updateButtonStates();
                
                console.log('å‰è¿›åˆ°æ­¥éª¤:', currentStep);
            }
        }
        
        // ä¸Šä¸€æ­¥
        function previousStep() {
            if (currentStep > 1) {
                // éšè—å½“å‰æ­¥éª¤
                document.getElementById(`step${currentStep}`).style.display = 'none';
                
                // æ›´æ–°è¿›åº¦
                document.querySelector(`[data-step="${currentStep}"]`).classList.remove('active');
                
                currentStep--;
                
                // æ˜¾ç¤ºä¸Šä¸€æ­¥éª¤
                document.getElementById(`step${currentStep}`).style.display = 'block';
                document.querySelector(`[data-step="${currentStep}"]`).classList.remove('completed');
                document.querySelector(`[data-step="${currentStep}"]`).classList.add('active');
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                updateButtonStates();
                
                console.log('è¿”å›åˆ°æ­¥éª¤:', currentStep);
            }
        }
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtonStates() {
            const prevButton = document.getElementById('prevButton');
            const nextButton = document.getElementById('nextButton');
            const createButton = document.getElementById('createButton');
            
            // ä¸Šä¸€æ­¥æŒ‰é’®
            prevButton.style.display = currentStep > 1 ? 'block' : 'none';
            
            if (currentStep === 3) {
                // æœ€åä¸€æ­¥
                nextButton.style.display = 'none';
                createButton.style.display = 'block';
            } else {
                nextButton.style.display = 'block';
                createButton.style.display = 'none';
                
                // æ ¹æ®å½“å‰æ­¥éª¤è®¾ç½®ä¸‹ä¸€æ­¥æŒ‰é’®çŠ¶æ€
                if (currentStep === 1) {
                    nextButton.disabled = !selectedType;
                } else if (currentStep === 2) {
                    nextButton.disabled = !characterData.name;
                }
            }
        }
        
        // éšæœºå±æ€§
        function rollAttributes() {
            const rollButton = document.getElementById('rollButton');
            rollButton.disabled = true;
            rollButton.textContent = 'ğŸ² æŠ•æ·ä¸­...';
            
            setTimeout(() => {
                // ç”Ÿæˆéšæœºå±æ€§
                characterData = generateRandomAttributes();
                
                // æ˜¾ç¤ºå±æ€§
                displayAttributes();
                
                // æ˜¾ç¤ºå±æ€§åŒºåŸŸ
                document.getElementById('attributeDisplay').style.display = 'grid';
                
                // å¯ç”¨ä¸‹ä¸€æ­¥
                document.getElementById('nextButton').disabled = false;
                
                // æ¢å¤æŒ‰é’®
                rollButton.disabled = false;
                rollButton.textContent = 'ğŸ² é‡æ–°æŠ•æ·';
                
                console.log('ç”Ÿæˆè§’è‰²å±æ€§:', characterData);
            }, 1000);
        }
        
        // è‡ªåŠ¨æŠ•æ·
        function autoRoll() {
            const autoButton = document.getElementById('autoRollButton');
            autoButton.disabled = true;
            autoButton.textContent = 'âš¡ è‡ªåŠ¨æŠ•æ·ä¸­...';
            
            let rollCount = 0;
            const maxRolls = 10;
            
            const autoRollInterval = setInterval(() => {
                rollCount++;
                
                // ç”Ÿæˆå±æ€§
                const tempData = generateRandomAttributes();
                displayAttributes(tempData);
                
                if (rollCount >= maxRolls) {
                    clearInterval(autoRollInterval);
                    
                    // ä¿å­˜æœ€åä¸€æ¬¡ç»“æœ
                    characterData = tempData;
                    
                    // æ˜¾ç¤ºå±æ€§åŒºåŸŸ
                    document.getElementById('attributeDisplay').style.display = 'grid';
                    
                    // å¯ç”¨ä¸‹ä¸€æ­¥
                    document.getElementById('nextButton').disabled = false;
                    
                    // æ¢å¤æŒ‰é’®
                    autoButton.disabled = false;
                    autoButton.textContent = 'âš¡ è‡ªåŠ¨æŠ•æ· (10æ¬¡)';
                }
            }, 200);
        }
        
        // ç”Ÿæˆéšæœºå±æ€§
        function generateRandomAttributes() {
            const isMale = Math.random() > 0.5;
            const surname = surnames[Math.floor(Math.random() * surnames.length)];
            const firstName = isMale ? 
                maleNames[Math.floor(Math.random() * maleNames.length)] :
                femaleNames[Math.floor(Math.random() * femaleNames.length)];
            
            // éšæœºçµæ ¹
            const spiritualRoot = rollSpiritualRoot();
            
            return {
                name: surname + firstName,
                age: Math.floor(Math.random() * 10) + 16, // 16-25å²
                gender: isMale ? 'ç”·' : 'å¥³',
                spiritual_root: spiritualRoot.name,
                spiritual_root_quality: spiritualRoot.quality,
                comprehension: Math.floor(Math.random() * 6) + 3, // 3-8
                luck: Math.floor(Math.random() * 6) + 3, // 3-8
                charisma: Math.floor(Math.random() * 6) + 3, // 3-8
                willpower: Math.floor(Math.random() * 6) + 3, // 3-8
                type: selectedType
            };
        }
        
        // æŠ•æ·çµæ ¹
        function rollSpiritualRoot() {
            const random = Math.random();
            let cumulative = 0;
            
            for (const [name, data] of Object.entries(spiritualRoots)) {
                cumulative += data.rarity;
                if (random <= cumulative) {
                    return { name, ...data };
                }
            }
            
            // é»˜è®¤è¿”å›äº”è¡Œçµæ ¹
            return { name: 'äº”è¡Œçµæ ¹', ...spiritualRoots['äº”è¡Œçµæ ¹'] };
        }
        
        // æ˜¾ç¤ºå±æ€§
        function displayAttributes(data = characterData) {
            document.getElementById('nameValue').textContent = data.name;
            document.getElementById('ageValue').textContent = data.age + 'å²';
            
            const rootElement = document.getElementById('rootValue');
            rootElement.textContent = data.spiritual_root;
            rootElement.style.color = spiritualRoots[data.spiritual_root]?.color || '#000';
            
            document.getElementById('comprehensionValue').textContent = data.comprehension;
            document.getElementById('luckValue').textContent = data.luck;
            document.getElementById('charismaValue').textContent = data.charisma;
        }
        
        // åˆ›å»ºè§’è‰²
        async function createCharacter() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.add('show');
            
            try {
                // å‘é€è§’è‰²æ•°æ®åˆ°æœåŠ¡å™¨
                const response = await fetch('/create_character', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(characterData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('è§’è‰²åˆ›å»ºæˆåŠŸ');
                    
                    // å¢¨æ™•è¿‡æ¸¡åˆ°æ¸¸æˆé¡µé¢
                    setTimeout(() => {
                        window.location.href = '/game' + (isDevMode ? '?mode=dev' : '');
                    }, 1500);
                } else {
                    throw new Error(result.error || 'åˆ›å»ºè§’è‰²å¤±è´¥');
                }
                
            } catch (error) {
                console.error('åˆ›å»ºè§’è‰²å¤±è´¥:', error);
                alert('åˆ›å»ºè§’è‰²å¤±è´¥ï¼š' + error.message);
                loadingOverlay.classList.remove('show');
            }
        }
        
        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ­ è§’è‰²åˆ›å»ºé¡µé¢åŠ è½½å®Œæˆ');
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateButtonStates();
            
            // å¦‚æœæ˜¯å¼€å‘æ¨¡å¼ï¼Œæ˜¾ç¤ºé¢å¤–ä¿¡æ¯
            if (isDevMode) {
                console.log('ğŸ”§ å¼€å‘æ¨¡å¼å·²å¯ç”¨');
                document.body.classList.add('dev-mode');
            }
            
            // é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !document.getElementById('nextButton').disabled) {
                    if (currentStep < 3) {
                        nextStep();
                    } else {
                        createCharacter();
                    }
                }
                
                if (e.key === 'Escape' && currentStep > 1) {
                    previousStep();
                }
                
                if (e.key === ' ' && currentStep === 2) {
                    e.preventDefault();
                    rollAttributes();
                }
            });
        });
        
        // é”™è¯¯å¤„ç†
        window.addEventListener('error', function(e) {
            console.error('é¡µé¢é”™è¯¯:', e.error);
            
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10000;
                background: #ff4444; color: white; padding: 15px;
                border-radius: 8px; max-width: 300px;
            `;
            errorDiv.innerHTML = `
                <strong>âš ï¸ å‘ç”Ÿé”™è¯¯</strong><br>
                <small>${e.error.message}</small>
            `;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        });
    </script>
</body>
</html>