<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®ä»™ä¸–ç•Œå¼•æ“ - å‰ç«¯æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .error {
            background: #ffebee;
            color: #c62828;
        }
        .warning {
            background: #fff3e0;
            color: #e65100;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        #console {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 4px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª ä¿®ä»™ä¸–ç•Œå¼•æ“ - å‰ç«¯æµ‹è¯•</h1>
        <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•å‰ç«¯JavaScriptæ¨¡å—å’ŒåŠŸèƒ½</p>

        <div class="test-section">
            <h2>1. åŸºç¡€ç¯å¢ƒæµ‹è¯•</h2>
            <button onclick="testBasicEnvironment()">è¿è¡Œæµ‹è¯•</button>
            <div id="basic-test-results"></div>
        </div>

        <div class="test-section">
            <h2>2. æ¨¡å—åŠ è½½æµ‹è¯•</h2>
            <button onclick="testModuleLoading()">è¿è¡Œæµ‹è¯•</button>
            <div id="module-test-results"></div>
        </div>

        <div class="test-section">
            <h2>3. APIè¿æ¥æµ‹è¯•</h2>
            <button onclick="testAPIConnection()">è¿è¡Œæµ‹è¯•</button>
            <div id="api-test-results"></div>
        </div>

        <div class="test-section">
            <h2>4. æ¸¸æˆåŠŸèƒ½æµ‹è¯•</h2>
            <button onclick="testGameFunctions()">è¿è¡Œæµ‹è¯•</button>
            <div id="game-test-results"></div>
        </div>

        <div class="test-section">
            <h2>5. æ€§èƒ½æµ‹è¯•</h2>
            <button onclick="testPerformance()">è¿è¡Œæµ‹è¯•</button>
            <div id="performance-test-results"></div>
        </div>

        <div class="test-section">
            <h2>æ§åˆ¶å°è¾“å‡º</h2>
            <button onclick="clearConsole()">æ¸…ç©º</button>
            <div id="console"></div>
        </div>
    </div>

    <script>
        // æµ‹è¯•ç»“æœè®°å½•
        const testResults = {
            basic: [],
            modules: [],
            api: [],
            game: [],
            performance: []
        };

        // æ§åˆ¶å°è¾“å‡º
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ef5350' : type === 'success' ? '#66bb6a' : '#aed581';
            console.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            console.scrollTop = console.scrollHeight;
        }

        function clearConsole() {
            document.getElementById('console').innerHTML = '';
        }

        // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
        function showResults(containerId, results) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            results.forEach(result => {
                const div = document.createElement('div');
                div.className = `test-result ${result.status}`;
                div.innerHTML = `
                    <strong>${result.status === 'success' ? 'âœ…' : result.status === 'error' ? 'âŒ' : 'âš ï¸'} ${result.test}</strong>
                    ${result.message ? `<p>${result.message}</p>` : ''}
                    ${result.details ? `<pre>${JSON.stringify(result.details, null, 2)}</pre>` : ''}
                `;
                container.appendChild(div);
            });
        }

        // 1. åŸºç¡€ç¯å¢ƒæµ‹è¯•
        async function testBasicEnvironment() {
            log('å¼€å§‹åŸºç¡€ç¯å¢ƒæµ‹è¯•...');
            const results = [];

            // æµ‹è¯•æµè§ˆå™¨æ”¯æŒ
            results.push({
                test: 'æµè§ˆå™¨ç‰¹æ€§æ”¯æŒ',
                status: 'success',
                details: {
                    localStorage: typeof(Storage) !== "undefined",
                    fetch: typeof(fetch) !== "undefined",
                    promises: typeof(Promise) !== "undefined",
                    modules: 'noModule' in HTMLScriptElement.prototype
                }
            });

            // æµ‹è¯•Service Workeræ”¯æŒ
            if ('serviceWorker' in navigator) {
                results.push({
                    test: 'Service Workeræ”¯æŒ',
                    status: 'success',
                    message: 'PWAåŠŸèƒ½å¯ç”¨'
                });
            } else {
                results.push({
                    test: 'Service Workeræ”¯æŒ',
                    status: 'warning',
                    message: 'PWAåŠŸèƒ½ä¸å¯ç”¨'
                });
            }

            // æµ‹è¯•WebAudioæ”¯æŒ
            if (window.AudioContext || window.webkitAudioContext) {
                results.push({
                    test: 'Web Audio APIæ”¯æŒ',
                    status: 'success',
                    message: 'éŸ³é¢‘åŠŸèƒ½å¯ç”¨'
                });
            } else {
                results.push({
                    test: 'Web Audio APIæ”¯æŒ',
                    status: 'error',
                    message: 'éŸ³é¢‘åŠŸèƒ½ä¸å¯ç”¨'
                });
            }

            testResults.basic = results;
            showResults('basic-test-results', results);
            log('åŸºç¡€ç¯å¢ƒæµ‹è¯•å®Œæˆ', 'success');
        }

        // 2. æ¨¡å—åŠ è½½æµ‹è¯•
        async function testModuleLoading() {
            log('å¼€å§‹æ¨¡å—åŠ è½½æµ‹è¯•...');
            const results = [];

            // æµ‹è¯•åŠ è½½CSS
            try {
                const response = await fetch('/static/css/ink_style.css');
                results.push({
                    test: 'CSSæ ·å¼æ–‡ä»¶',
                    status: response.ok ? 'success' : 'error',
                    message: response.ok ? 'æ°´å¢¨é£æ ·å¼åŠ è½½æˆåŠŸ' : `åŠ è½½å¤±è´¥: ${response.status}`
                });
            } catch (e) {
                results.push({
                    test: 'CSSæ ·å¼æ–‡ä»¶',
                    status: 'error',
                    message: `é”™è¯¯: ${e.message}`
                });
            }

            // æµ‹è¯•åŠ è½½JavaScriptæ¨¡å—
            const jsModules = [
                '/static/js/game_controller.js',
                '/static/js/modules/ui_controller.js',
                '/static/js/modules/audio_controller.js',
                '/static/js/modules/player_profile.js',
                '/static/js/modules/modal_controller.js'
            ];

            for (const module of jsModules) {
                try {
                    const response = await fetch(module);
                    results.push({
                        test: `JSæ¨¡å—: ${module.split('/').pop()}`,
                        status: response.ok ? 'success' : 'error',
                        message: response.ok ? 'åŠ è½½æˆåŠŸ' : `åŠ è½½å¤±è´¥: ${response.status}`
                    });
                } catch (e) {
                    results.push({
                        test: `JSæ¨¡å—: ${module.split('/').pop()}`,
                        status: 'error',
                        message: `é”™è¯¯: ${e.message}`
                    });
                }
            }

            testResults.modules = results;
            showResults('module-test-results', results);
            log('æ¨¡å—åŠ è½½æµ‹è¯•å®Œæˆ', 'success');
        }

        // 3. APIè¿æ¥æµ‹è¯•
        async function testAPIConnection() {
            log('å¼€å§‹APIè¿æ¥æµ‹è¯•...');
            const results = [];

            // æµ‹è¯•åŸºç¡€è¿æ¥
            try {
                const response = await fetch('/');
                results.push({
                    test: 'æœåŠ¡å™¨è¿æ¥',
                    status: response.ok || response.status === 302 ? 'success' : 'error',
                    message: `çŠ¶æ€ç : ${response.status}`
                });
            } catch (e) {
                results.push({
                    test: 'æœåŠ¡å™¨è¿æ¥',
                    status: 'error',
                    message: `æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨: ${e.message}`
                });
            }

            // æµ‹è¯•APIç«¯ç‚¹
            const endpoints = [
                { path: '/status', method: 'GET', name: 'çŠ¶æ€API' },
                { path: '/log', method: 'GET', name: 'æ—¥å¿—API' },
                { path: '/get_audio_list', method: 'GET', name: 'éŸ³é¢‘åˆ—è¡¨API' }
            ];

            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint.path, { method: endpoint.method });
                    const isSuccess = response.ok || (endpoint.path === '/status' && response.status === 401);
                    
                    results.push({
                        test: endpoint.name,
                        status: isSuccess ? 'success' : 'error',
                        message: `${endpoint.method} ${endpoint.path} - çŠ¶æ€: ${response.status}`
                    });

                    if (response.ok) {
                        try {
                            const data = await response.json();
                            log(`${endpoint.name} è¿”å›æ•°æ®: ${JSON.stringify(data).substring(0, 100)}...`);
                        } catch (e) {
                            log(`${endpoint.name} è¿”å›éJSONæ•°æ®`, 'warning');
                        }
                    }
                } catch (e) {
                    results.push({
                        test: endpoint.name,
                        status: 'error',
                        message: `é”™è¯¯: ${e.message}`
                    });
                }
            }

            testResults.api = results;
            showResults('api-test-results', results);
            log('APIè¿æ¥æµ‹è¯•å®Œæˆ', 'success');
        }

        // 4. æ¸¸æˆåŠŸèƒ½æµ‹è¯•
        async function testGameFunctions() {
            log('å¼€å§‹æ¸¸æˆåŠŸèƒ½æµ‹è¯•...');
            const results = [];

            // æµ‹è¯•æœ¬åœ°å­˜å‚¨
            try {
                localStorage.setItem('test_key', 'test_value');
                const value = localStorage.getItem('test_key');
                localStorage.removeItem('test_key');
                
                results.push({
                    test: 'æœ¬åœ°å­˜å‚¨åŠŸèƒ½',
                    status: value === 'test_value' ? 'success' : 'error',
                    message: 'æ¸¸æˆå­˜æ¡£åŠŸèƒ½å¯ç”¨'
                });
            } catch (e) {
                results.push({
                    test: 'æœ¬åœ°å­˜å‚¨åŠŸèƒ½',
                    status: 'error',
                    message: `é”™è¯¯: ${e.message}`
                });
            }

            // æµ‹è¯•JSONè§£æ
            try {
                const testData = { player: { name: 'æµ‹è¯•ç©å®¶', level: 1 } };
                const json = JSON.stringify(testData);
                const parsed = JSON.parse(json);
                
                results.push({
                    test: 'JSONæ•°æ®å¤„ç†',
                    status: parsed.player.name === 'æµ‹è¯•ç©å®¶' ? 'success' : 'error',
                    message: 'æ•°æ®åºåˆ—åŒ–åŠŸèƒ½æ­£å¸¸'
                });
            } catch (e) {
                results.push({
                    test: 'JSONæ•°æ®å¤„ç†',
                    status: 'error',
                    message: `é”™è¯¯: ${e.message}`
                });
            }

            // æµ‹è¯•äº‹ä»¶ç³»ç»Ÿ
            try {
                let eventFired = false;
                const testHandler = () => { eventFired = true; };
                
                window.addEventListener('test-event', testHandler);
                window.dispatchEvent(new CustomEvent('test-event'));
                window.removeEventListener('test-event', testHandler);
                
                results.push({
                    test: 'äº‹ä»¶ç³»ç»Ÿ',
                    status: eventFired ? 'success' : 'error',
                    message: 'äº‹ä»¶è§¦å‘å’Œç›‘å¬æ­£å¸¸'
                });
            } catch (e) {
                results.push({
                    test: 'äº‹ä»¶ç³»ç»Ÿ',
                    status: 'error',
                    message: `é”™è¯¯: ${e.message}`
                });
            }

            // æµ‹è¯•å®šæ—¶å™¨
            results.push({
                test: 'å®šæ—¶å™¨åŠŸèƒ½',
                status: 'success',
                message: 'æ¸¸æˆå¾ªç¯æ”¯æŒå¯ç”¨',
                details: {
                    setTimeout: typeof setTimeout === 'function',
                    setInterval: typeof setInterval === 'function',
                    requestAnimationFrame: typeof requestAnimationFrame === 'function'
                }
            });

            testResults.game = results;
            showResults('game-test-results', results);
            log('æ¸¸æˆåŠŸèƒ½æµ‹è¯•å®Œæˆ', 'success');
        }

        // 5. æ€§èƒ½æµ‹è¯•
        async function testPerformance() {
            log('å¼€å§‹æ€§èƒ½æµ‹è¯•...');
            const results = [];

            // æµ‹è¯•æ¸²æŸ“æ€§èƒ½
            const startTime = performance.now();
            for (let i = 0; i < 1000; i++) {
                const div = document.createElement('div');
                div.textContent = `æµ‹è¯•å…ƒç´  ${i}`;
                document.body.appendChild(div);
                document.body.removeChild(div);
            }
            const renderTime = performance.now() - startTime;

            results.push({
                test: 'DOMæ¸²æŸ“æ€§èƒ½',
                status: renderTime < 100 ? 'success' : renderTime < 500 ? 'warning' : 'error',
                message: `1000æ¬¡DOMæ“ä½œè€—æ—¶: ${renderTime.toFixed(2)}ms`,
                details: {
                    operations: 1000,
                    totalTime: renderTime.toFixed(2),
                    avgTime: (renderTime / 1000).toFixed(2)
                }
            });

            // æµ‹è¯•å†…å­˜ä½¿ç”¨
            if (performance.memory) {
                results.push({
                    test: 'å†…å­˜ä½¿ç”¨æƒ…å†µ',
                    status: 'success',
                    details: {
                        used: Math.round(performance.memory.usedJSHeapSize / 1048576) + ' MB',
                        total: Math.round(performance.memory.totalJSHeapSize / 1048576) + ' MB',
                        limit: Math.round(performance.memory.jsHeapSizeLimit / 1048576) + ' MB'
                    }
                });
            }

            // æµ‹è¯•ç½‘ç»œå»¶è¿Ÿ
            const pingStart = performance.now();
            try {
                await fetch('/status');
                const pingTime = performance.now() - pingStart;
                
                results.push({
                    test: 'ç½‘ç»œå»¶è¿Ÿ',
                    status: pingTime < 50 ? 'success' : pingTime < 200 ? 'warning' : 'error',
                    message: `APIå“åº”æ—¶é—´: ${pingTime.toFixed(2)}ms`
                });
            } catch (e) {
                results.push({
                    test: 'ç½‘ç»œå»¶è¿Ÿ',
                    status: 'error',
                    message: 'æ— æ³•æµ‹è¯•ç½‘ç»œå»¶è¿Ÿ'
                });
            }

            testResults.performance = results;
            showResults('performance-test-results', results);
            log('æ€§èƒ½æµ‹è¯•å®Œæˆ', 'success');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºç¡€æµ‹è¯•
        window.addEventListener('DOMContentLoaded', () => {
            log('å‰ç«¯æµ‹è¯•é¡µé¢å·²åŠ è½½');
            log('ç‚¹å‡»å„ä¸ªæµ‹è¯•æŒ‰é’®å¼€å§‹æµ‹è¯•');
        });
    </script>
</body>
</html>
