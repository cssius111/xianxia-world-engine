# DeepSeek MCP 自然语言命令解析使用指南

## 概述

修仙世界引擎现已集成 DeepSeek MCP（Model as Command Parser）功能，允许玩家使用自然语言输入命令，系统会智能解析为游戏可执行的结构化指令。

## 功能特点

1. **自然语言理解**：支持口语化的命令输入，如"四处看看"、"休息一会儿"等
2. **智能参数提取**：自动识别时间、地点、物品等参数
3. **多步命令支持**：可以解析"先探索再修炼"这样的复合命令
4. **本地回退机制**：网络问题时自动切换到本地解析，保证游戏体验
5. **性能监控**：实时跟踪解析性能和使用情况

## 使用方法

### 1. 配置 DeepSeek API

在 `.env` 文件中设置您的 DeepSeek API 密钥：

```bash
DEEPSEEK_API_KEY=your_api_key_here
```

### 2. 启动游戏

```bash
python start_web.py
```

系统会自动检测并启用 NLP 功能。如果 API 密钥未设置或无效，将自动使用传统命令解析。

### 3. 自然语言命令示例

#### 探索类
- "四处看看" → 探索当前区域
- "随便走走" → 闲逛探索
- "到处逛逛" → 探索周围

#### 修炼类
- "休息一会儿" → 打坐修炼
- "修炼三个时辰" → 指定时间修炼
- "快速闭关一天" → 快速修炼模式

#### 移动类
- "去丹药铺" → 前往丹药铺
- "到青云峰看看" → 移动到青云峰
- "前往藏经阁" → 前往藏经阁

#### 交互类
- "和李掌柜聊聊天" → 与NPC对话
- "使用回春丹" → 使用物品
- "打开背包看看" → 查看背包

#### 复合命令
- "先探索再修炼" → 依次执行探索和修炼
- "去丹药铺买些疗伤药" → 前往并交易

## 性能监控

访问 `/nlp_monitor` 查看 NLP 系统的性能数据：

- 请求统计：总请求数、成功率、缓存命中率
- 性能指标：平均响应时间、请求速率
- 使用分析：热门命令、处理器使用情况
- 成本追踪：Token使用量和预估费用

## 配置选项

NLP 系统支持以下配置（在 `config/nlp_config.json` 中设置）：

```json
{
  "enabled": true,              // 是否启用NLP
  "cache_size": 128,            // 缓存大小
  "timeout": 30,                // API超时时间（秒）
  "temperature": 0.0,           // 生成温度（0=确定性）
  "max_tokens": 256,            // 最大生成token数
  "fallback_enabled": true,     // 启用本地回退
  "performance_monitoring": true // 性能监控
}
```

## 故障排除

### NLP 未启用
1. 检查 `.env` 文件中的 `DEEPSEEK_API_KEY` 是否正确设置
2. 查看控制台日志中的错误信息
3. 访问 `/nlp_monitor` 查看系统状态

### 响应缓慢
1. 检查网络连接
2. 查看性能监控面板，了解平均响应时间
3. 考虑增加缓存大小以提高命中率

### 解析不准确
1. 使用更明确的表达方式
2. 查看游戏内的命令提示
3. 检查是否在使用本地回退模式

## API 限制

- 默认限制：20次/分钟，500次/小时
- 超出限制会自动切换到本地解析
- 可在配置文件中调整限制

## 成本优化建议

1. **启用缓存**：相同命令会使用缓存结果，不产生额外费用
2. **使用快捷按钮**：界面上的快捷命令按钮不会调用 API
3. **批量操作**：尽量使用复合命令减少 API 调用次数

## 开发者信息

### 扩展命令支持

要添加新的命令支持，需要：

1. 在 `nlp_processor.py` 的 prompt 模板中添加示例
2. 在 `command_router.py` 中添加命令映射
3. 在 `run.py` 中实现具体的命令处理逻辑

### 性能优化

- 缓存使用 LRU 策略，自动淘汰最少使用的结果
- 支持批量解析以减少 API 调用
- 本地回退使用模式匹配，速度极快

### 监控数据导出

性能数据可通过 API 导出为 JSON 格式，用于进一步分析：

```bash
curl http://localhost:5001/api/nlp/export > nlp_metrics.json
```

## 更新日志

### v1.0.0 (2025-06-25)
- 初始版本发布
- 集成 DeepSeek API
- 实现基础命令解析
- 添加性能监控面板
- 支持缓存和本地回退

---

如有问题或建议，请提交 Issue 或 Pull Request。
