# éƒ¨ç½²éªŒè¯æ¸…å•

## ğŸš€ XianXia World Engine NLP æ¨¡å—éƒ¨ç½²éªŒè¯

### 1. ç¯å¢ƒé…ç½®éªŒè¯

- [ ] **Python ç‰ˆæœ¬**
  - ç¡®è®¤ Python >= 3.8
  - å‘½ä»¤: `python --version`
  
- [ ] **ä¾èµ–åŒ…å®‰è£…**
  - å®‰è£…æ‰€æœ‰å¿…éœ€ä¾èµ–: `pip install -r requirements.txt`
  - éªŒè¯ prometheus-flask-exporter: `pip show prometheus-flask-exporter`
  - éªŒè¯å…¶ä»–å…³é”®åŒ…: `pip list | grep -E "Flask|requests|psutil"`

- [ ] **ç¯å¢ƒå˜é‡é…ç½®**
  ```bash
  # å¿…éœ€çš„ç¯å¢ƒå˜é‡
  export DEEPSEEK_API_KEY="your-api-key"
  export ENABLE_PROMETHEUS="true"
  export ENABLE_CONTEXT_COMPRESSION="true"
  export USE_MOCK_LLM="false"  # ç”Ÿäº§ç¯å¢ƒè®¾ä¸º false
  export XWE_MAX_LLM_RETRIES="3"
  export LLM_ASYNC_WORKERS="5"
  ```

### 2. API å¯†é’¥éªŒè¯

- [ ] **DeepSeek API å¯†é’¥**
  - ç¡®è®¤å¯†é’¥å·²è®¾ç½®: `echo $DEEPSEEK_API_KEY`
  - æµ‹è¯• API è¿æ¥:
    ```python
    from xwe.core.nlp.llm_client import LLMClient
    client = LLMClient()
    response = client.chat("æµ‹è¯•è¿æ¥")
    print(response)
    ```

### 3. ç›‘æ§ç«¯ç‚¹æ£€æŸ¥

- [ ] **Prometheus æŒ‡æ ‡ç«¯ç‚¹**
  - è®¿é—®: `http://localhost:5000/metrics`
  - éªŒè¯è‡ªå®šä¹‰æŒ‡æ ‡å­˜åœ¨:
    - `xwe_nlp_request_seconds`
    - `xwe_nlp_token_count`
    - `xwe_nlp_cache_hit_total`
    - `xwe_context_compression_total`

- [ ] **å¥åº·æ£€æŸ¥ç«¯ç‚¹**
  - åŸºç¡€å¥åº·æ£€æŸ¥: `curl http://localhost:5000/health`
  - è¯¦ç»†å¥åº·æ£€æŸ¥: `curl http://localhost:5000/health/detailed`

### 4. æ€§èƒ½åŸºå‡†éªŒè¯

- [ ] **å“åº”æ—¶é—´æµ‹è¯•**
  ```bash
  # å•ä¸ªè¯·æ±‚æµ‹è¯•
  time curl -X POST http://localhost:5000/api/game/command \
    -H "Content-Type: application/json" \
    -d '{"command": "æ¢ç´¢å‘¨å›´ç¯å¢ƒ"}'
  ```
  - ç›®æ ‡: å¹³å‡å“åº”æ—¶é—´ < 1ç§’

- [ ] **å¹¶å‘æ€§èƒ½æµ‹è¯•**
  ```bash
  # ä½¿ç”¨ ab è¿›è¡Œç®€å•å‹æµ‹
  ab -n 100 -c 10 -p test_data.json -T application/json \
    http://localhost:5000/api/game/command
  ```
  - ç›®æ ‡: æ”¯æŒ 50+ QPS

- [ ] **å†…å­˜ä½¿ç”¨éªŒè¯**
  - å¯åŠ¨æ—¶å†…å­˜: < 200MB
  - è¿è¡Œ1å°æ—¶å: < 500MB
  - æ— æ˜æ˜¾å†…å­˜æ³„æ¼

### 5. æ—¥å¿—é…ç½®éªŒè¯

- [ ] **æ—¥å¿—æ–‡ä»¶ä½ç½®**
  - ç¡®è®¤æ—¥å¿—ç›®å½•å­˜åœ¨: `ls -la logs/`
  - æ£€æŸ¥æ—¥å¿—è½®è½¬é…ç½®

- [ ] **æ—¥å¿—çº§åˆ«è®¾ç½®**
  - ç”Ÿäº§ç¯å¢ƒ: `LOG_LEVEL=INFO`
  - è°ƒè¯•æ—¶: `LOG_LEVEL=DEBUG`

- [ ] **æ—¥å¿—æ ¼å¼éªŒè¯**
  - åŒ…å«æ—¶é—´æˆ³ã€çº§åˆ«ã€æ¨¡å—ã€æ¶ˆæ¯
  - ç¤ºä¾‹: `2024-03-14 10:30:45 INFO [xwe.nlp] Processing command: æ¢ç´¢`

### 6. é”™è¯¯å¤„ç†éªŒè¯

- [ ] **API è¶…æ—¶å¤„ç†**
  - è®¾ç½®çŸ­è¶…æ—¶æµ‹è¯•: `LLM_TIMEOUT=1`
  - éªŒè¯ä¼˜é›…é™çº§

- [ ] **æ— æ•ˆè¾“å…¥å¤„ç†**
  ```bash
  # æµ‹è¯•ç©ºè¾“å…¥
  curl -X POST http://localhost:5000/api/game/command \
    -H "Content-Type: application/json" \
    -d '{"command": ""}'
  
  # æµ‹è¯•è¶…é•¿è¾“å…¥
  curl -X POST http://localhost:5000/api/game/command \
    -H "Content-Type: application/json" \
    -d '{"command": "'$(python -c "print('x'*10000)")'"}'
  ```

- [ ] **å¹¶å‘é”™è¯¯å¤„ç†**
  - åŒæ—¶å‘é€100ä¸ªè¯·æ±‚
  - éªŒè¯æ— å´©æºƒï¼Œé”™è¯¯ç‡ < 5%

### 7. èµ„æºé™åˆ¶è®¾ç½®

- [ ] **è¿›ç¨‹é™åˆ¶**
  ```bash
  # è®¾ç½®æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
  ulimit -n 65536
  
  # è®¾ç½®æœ€å¤§è¿›ç¨‹æ•°
  ulimit -u 4096
  ```

- [ ] **å†…å­˜é™åˆ¶**
  - ä½¿ç”¨ systemd æˆ– Docker è®¾ç½®å†…å­˜ä¸Šé™
  - å»ºè®®: 2GB

- [ ] **CPU é™åˆ¶**
  - é™åˆ¶ CPU ä½¿ç”¨ç‡é¿å…å½±å“å…¶ä»–æœåŠ¡
  - å»ºè®®: 80% æœ€å¤§ä½¿ç”¨ç‡

### 8. å®‰å…¨é…ç½®

- [ ] **API å¯†é’¥ä¿æŠ¤**
  - ä¸åœ¨ä»£ç ä¸­ç¡¬ç¼–ç 
  - ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†æœåŠ¡

- [ ] **è¾“å…¥éªŒè¯**
  - SQL æ³¨å…¥é˜²æŠ¤
  - XSS é˜²æŠ¤
  - è·¯å¾„éå†é˜²æŠ¤

- [ ] **è®¿é—®æ§åˆ¶**
  - é™åˆ¶ /metrics ç«¯ç‚¹è®¿é—®
  - API è®¤è¯æœºåˆ¶

### 9. ç›‘æ§é›†æˆ

- [ ] **Prometheus é…ç½®**
  ```yaml
  # prometheus.yml
  scrape_configs:
    - job_name: 'xwe'
      static_configs:
        - targets: ['localhost:5000']
      scrape_interval: 15s
  ```

- [ ] **Grafana ä»ªè¡¨æ¿**
  - å¯¼å…¥æä¾›çš„ä»ªè¡¨æ¿æ¨¡æ¿
  - è®¾ç½®å‘Šè­¦è§„åˆ™

- [ ] **å‘Šè­¦é…ç½®**
  - é«˜å»¶è¿Ÿå‘Šè­¦ (> 5ç§’)
  - é«˜é”™è¯¯ç‡å‘Šè­¦ (> 10%)
  - å†…å­˜ä½¿ç”¨å‘Šè­¦ (> 1GB)

### 10. å›æ»šæ–¹æ¡ˆ

- [ ] **å¤‡ä»½å½“å‰ç‰ˆæœ¬**
  ```bash
  # å¤‡ä»½ä»£ç 
  tar -czf xwe_backup_$(date +%Y%m%d).tar.gz /path/to/xwe
  
  # å¤‡ä»½é…ç½®
  cp -r config/ config_backup_$(date +%Y%m%d)/
  ```

- [ ] **æ•°æ®åº“å¤‡ä»½**
  - å¦‚æœä½¿ç”¨æ•°æ®åº“ï¼Œç¡®ä¿æœ‰å¤‡ä»½

- [ ] **å¿«é€Ÿå›æ»šè„šæœ¬**
  ```bash
  #!/bin/bash
  # rollback.sh
  systemctl stop xwe
  rm -rf /path/to/xwe
  tar -xzf xwe_backup_latest.tar.gz -C /
  systemctl start xwe
  ```

### 11. æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥

- [ ] **å¯ç”¨ä¸Šä¸‹æ–‡å‹ç¼©**
  - éªŒè¯: `ENABLE_CONTEXT_COMPRESSION=true`
  - æ£€æŸ¥å‹ç¼©ç‡ > 30%

- [ ] **å¼‚æ­¥å¤„ç†å¯ç”¨**
  - éªŒè¯çº¿ç¨‹æ± å¤§å°åˆç†
  - æ£€æŸ¥é˜Ÿåˆ—ä¸ä¼šæ— é™å¢é•¿

- [ ] **ç¼“å­˜é…ç½®**
  - NLP ç»“æœç¼“å­˜å¯ç”¨
  - ç¼“å­˜å‘½ä¸­ç‡ > 20%

### 12. éƒ¨ç½²åéªŒè¯

- [ ] **åŠŸèƒ½æµ‹è¯•**
  ```bash
  # è¿è¡Œå¿«é€ŸåŠŸèƒ½æµ‹è¯•
  pytest tests/integration/test_deployment.py -v
  ```

- [ ] **æ€§èƒ½åŸºå‡†å¯¹æ¯”**
  - ä¸æµ‹è¯•ç¯å¢ƒåŸºå‡†å¯¹æ¯”
  - æ€§èƒ½ä¸‹é™ < 10%

- [ ] **ç›‘æ§æ•°æ®éªŒè¯**
  - Prometheus æ­£å¸¸æ”¶é›†æ•°æ®
  - Grafana å›¾è¡¨æ­£å¸¸æ˜¾ç¤º

- [ ] **æ—¥å¿—å®¡æŸ¥**
  - æ— å¼‚å¸¸é”™è¯¯æ—¥å¿—
  - æ— é¢‘ç¹çš„è­¦å‘Š

### 13. æ–‡æ¡£æ›´æ–°

- [ ] **éƒ¨ç½²æ–‡æ¡£**
  - è®°å½•å®é™…éƒ¨ç½²æ­¥éª¤
  - è®°å½•é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

- [ ] **è¿ç»´æ‰‹å†Œ**
  - å¸¸è§é—®é¢˜å¤„ç†
  - æ€§èƒ½è°ƒä¼˜å»ºè®®
  - æ•…éšœæ’æŸ¥æ­¥éª¤

### 14. åŸ¹è®­å’Œäº¤æ¥

- [ ] **è¿ç»´å›¢é˜ŸåŸ¹è®­**
  - ç³»ç»Ÿæ¶æ„è¯´æ˜
  - ç›‘æ§æŒ‡æ ‡è§£è¯»
  - æ•…éšœå¤„ç†æµç¨‹

- [ ] **å€¼ç­å®‰æ’**
  - 24/7 å€¼ç­è¡¨
  - ç´§æ€¥è”ç³»æ–¹å¼
  - å‡çº§æµç¨‹

## ç­¾å­—ç¡®è®¤

| è§’è‰² | å§“å | æ—¥æœŸ | ç­¾å |
|------|------|------|------|
| å¼€å‘è´Ÿè´£äºº | | | |
| æµ‹è¯•è´Ÿè´£äºº | | | |
| è¿ç»´è´Ÿè´£äºº | | | |
| é¡¹ç›®ç»ç† | | | |

---

**æ³¨æ„**: æ‰€æœ‰æ£€æŸ¥é¡¹å¿…é¡»é€šè¿‡æ‰èƒ½æ­£å¼ä¸Šçº¿ã€‚å¦‚æœ‰ä»»ä½•é¡¹ç›®æœªé€šè¿‡ï¼Œéœ€è®°å½•åŸå› å¹¶åˆ¶å®šè§£å†³æ–¹æ¡ˆã€‚
