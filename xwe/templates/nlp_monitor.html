{% extends "base.html" %}

{% block title %}NLPç›‘æ§é¢æ¿ - ä¿®ä»™ä¸–ç•Œå¼•æ“{% endblock %}

{% block content %}
<div class="nlp-monitor-container">
    <h1>ğŸ¤– NLP ç›‘æ§é¢æ¿</h1>
    
    <div class="monitor-grid">
        <!-- æ¦‚è§ˆå¡ç‰‡ -->
        <div class="monitor-card overview">
            <h2>ç³»ç»Ÿæ¦‚è§ˆ</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">è¿è¡Œæ—¶é—´</div>
                    <div class="stat-value" id="uptime">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">æ€»è¯·æ±‚æ•°</div>
                    <div class="stat-value" id="totalRequests">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">æˆåŠŸç‡</div>
                    <div class="stat-value" id="successRate">--%</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ç¼“å­˜å‘½ä¸­ç‡</div>
                    <div class="stat-value" id="cacheHitRate">--%</div>
                </div>
            </div>
        </div>
        
        <!-- æ€§èƒ½æŒ‡æ ‡ -->
        <div class="monitor-card performance">
            <h2>æ€§èƒ½æŒ‡æ ‡</h2>
            <div class="perf-stats">
                <div class="perf-item">
                    <span class="perf-label">å¹³å‡å“åº”æ—¶é—´</span>
                    <span class="perf-value" id="avgDuration">--ms</span>
                </div>
                <div class="perf-item">
                    <span class="perf-label">æœ€è¿‘5åˆ†é’Ÿå¹³å‡</span>
                    <span class="perf-value" id="recentAvgDuration">--ms</span>
                </div>
                <div class="perf-item">
                    <span class="perf-label">æ¯åˆ†é’Ÿè¯·æ±‚æ•°</span>
                    <span class="perf-value" id="rpm">--</span>
                </div>
                <div class="perf-item">
                    <span class="perf-label">Tokenä½¿ç”¨é‡</span>
                    <span class="perf-value" id="totalTokens">--</span>
                </div>
                <div class="perf-item">
                    <span class="perf-label">é¢„ä¼°æˆæœ¬</span>
                    <span class="perf-value" id="estimatedCost">$--</span>
                </div>
            </div>
        </div>
        
        <!-- çƒ­é—¨å‘½ä»¤ -->
        <div class="monitor-card commands">
            <h2>çƒ­é—¨å‘½ä»¤ TOP 10</h2>
            <div id="topCommands" class="command-list">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- å¤„ç†å™¨ä½¿ç”¨æƒ…å†µ -->
        <div class="monitor-card handlers">
            <h2>å¤„ç†å™¨ä½¿ç”¨æƒ…å†µ</h2>
            <div id="handlerUsage" class="handler-list">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- é”™è¯¯ç»Ÿè®¡ -->
        <div class="monitor-card errors">
            <h2>é”™è¯¯ç»Ÿè®¡</h2>
            <div id="errorSummary" class="error-list">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="monitor-card controls">
            <h2>æ§åˆ¶é¢æ¿</h2>
            <div class="control-buttons">
                <button class="control-btn" onclick="refreshStats()">
                    ğŸ”„ åˆ·æ–°æ•°æ®
                </button>
                <button class="control-btn" onclick="clearCache()">
                    ğŸ—‘ï¸ æ¸…é™¤ç¼“å­˜
                </button>
                <button class="control-btn" onclick="exportMetrics()">
                    ğŸ“¥ å¯¼å‡ºæ•°æ®
                </button>
                <button class="control-btn toggle" onclick="toggleAutoRefresh()">
                    â¸ï¸ è‡ªåŠ¨åˆ·æ–°
                </button>
            </div>
            
            <div class="config-section">
                <h3>é…ç½®çŠ¶æ€</h3>
                <div id="configStatus" class="config-status">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.nlp-monitor-container {
    padding: 20px;
    background: #1a1a2e;
    color: #e0e0e0;
    min-height: 100vh;
}

.nlp-monitor-container h1 {
    text-align: center;
    margin-bottom: 30px;
    font-size: 2.5em;
    background: linear-gradient(135deg, #bbb 0%, #ddd 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.monitor-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    max-width: 1400px;
    margin: 0 auto;
}

.monitor-card {
    background: rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(180, 180, 180, 0.2);
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.monitor-card h2 {
    margin-top: 0;
    margin-bottom: 20px;
    color: #bbb;
    font-size: 1.3em;
}

/* æ¦‚è§ˆå¡ç‰‡ */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
}

.stat-item {
    background: rgba(180, 180, 180, 0.1);
    padding: 15px;
    border-radius: 10px;
    text-align: center;
}

.stat-label {
    font-size: 0.9em;
    color: #888;
    margin-bottom: 5px;
}

.stat-value {
    font-size: 1.5em;
    font-weight: bold;
    color: #bbb;
}

/* æ€§èƒ½æŒ‡æ ‡ */
.perf-stats {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.perf-item {
    display: flex;
    justify-content: space-between;
    padding: 10px 15px;
    background: rgba(180, 180, 180, 0.05);
    border-radius: 8px;
}

.perf-label {
    color: #999;
}

.perf-value {
    font-weight: bold;
    color: #bbb;
}

/* å‘½ä»¤åˆ—è¡¨ */
.command-list, .handler-list, .error-list {
    max-height: 300px;
    overflow-y: auto;
}

.command-item, .handler-item, .error-item {
    padding: 10px;
    border-bottom: 1px solid rgba(180, 180, 180, 0.1);
    display: flex;
    justify-content: space-between;
}

.command-item:last-child,
.handler-item:last-child,
.error-item:last-child {
    border-bottom: none;
}

.command-text, .handler-name, .error-type {
    color: #e0e0e0;
}

.command-count, .handler-count, .error-count {
    color: #bbb;
    font-weight: bold;
}

/* æ§åˆ¶æŒ‰é’® */
.control-buttons {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 20px;
}

.control-btn {
    padding: 12px 20px;
    background: rgba(180, 180, 180, 0.1);
    border: 1px solid rgba(180, 180, 180, 0.3);
    border-radius: 10px;
    color: #e0e0e0;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s;
}

.control-btn:hover {
    background: rgba(180, 180, 180, 0.2);
    transform: translateY(-2px);
}

.control-btn.active {
    background: rgba(180, 180, 180, 0.3);
    border-color: #bbb;
}

/* é…ç½®çŠ¶æ€ */
.config-status {
    background: rgba(180, 180, 180, 0.05);
    padding: 15px;
    border-radius: 10px;
    font-size: 0.9em;
}

.config-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
}

.config-key {
    color: #999;
}

.config-value {
    color: #bbb;
}

/* æ»šåŠ¨æ¡æ ·å¼ */
::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    background: rgba(180, 180, 180, 0.3);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: rgba(180, 180, 180, 0.5);
}

/* å“åº”å¼ */
@media (max-width: 768px) {
    .monitor-grid {
        grid-template-columns: 1fr;
    }
    
    .control-buttons {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
let autoRefreshInterval = null;
let isAutoRefresh = true;

// åˆ·æ–°ç»Ÿè®¡æ•°æ®
async function refreshStats() {
    try {
        const response = await fetch('/api/nlp/stats');
        const data = await response.json();
        
        if (data.success) {
            updateUI(data.stats);
        }
    } catch (error) {
        console.error('è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
    }
}

// æ›´æ–°UI
function updateUI(stats) {
    // æ›´æ–°æ¦‚è§ˆ
    document.getElementById('uptime').textContent = stats.uptime_readable || '--';
    document.getElementById('totalRequests').textContent = stats.total_requests || '0';
    document.getElementById('successRate').textContent = (stats.success_rate || 0) + '%';
    document.getElementById('cacheHitRate').textContent = (stats.cache_hit_rate || 0) + '%';
    
    // æ›´æ–°æ€§èƒ½æŒ‡æ ‡
    document.getElementById('avgDuration').textContent = (stats.avg_duration_ms || 0).toFixed(2) + 'ms';
    document.getElementById('recentAvgDuration').textContent = (stats.recent_avg_duration_ms || 0).toFixed(2) + 'ms';
    document.getElementById('rpm').textContent = (stats.requests_per_minute || 0).toFixed(1);
    document.getElementById('totalTokens').textContent = stats.total_tokens || '0';
    document.getElementById('estimatedCost').textContent = '$' + (stats.estimated_cost || 0).toFixed(4);
    
    // æ›´æ–°çƒ­é—¨å‘½ä»¤
    const topCommandsDiv = document.getElementById('topCommands');
    if (stats.top_commands) {
        topCommandsDiv.innerHTML = stats.top_commands.map(([cmd, count], i) => `
            <div class="command-item">
                <span class="command-text">${i + 1}. ${cmd}</span>
                <span class="command-count">${count}æ¬¡</span>
            </div>
        `).join('');
    }
    
    // æ›´æ–°å¤„ç†å™¨ä½¿ç”¨æƒ…å†µ
    const handlerUsageDiv = document.getElementById('handlerUsage');
    if (stats.handler_usage) {
        handlerUsageDiv.innerHTML = stats.handler_usage.map(([handler, count]) => `
            <div class="handler-item">
                <span class="handler-name">${handler}</span>
                <span class="handler-count">${count}æ¬¡</span>
            </div>
        `).join('');
    }
}

// æ¸…é™¤ç¼“å­˜
async function clearCache() {
    if (!confirm('ç¡®å®šè¦æ¸…é™¤NLPç¼“å­˜å—ï¼Ÿ')) return;
    
    try {
        const response = await fetch('/clear_nlp_cache', {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            alert('ç¼“å­˜å·²æ¸…é™¤');
            refreshStats();
        }
    } catch (error) {
        console.error('æ¸…é™¤ç¼“å­˜å¤±è´¥:', error);
    }
}

// å¯¼å‡ºæ•°æ®
async function exportMetrics() {
    try {
        const response = await fetch('/api/nlp/export');
        const blob = await response.blob();
        
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `nlp_metrics_${new Date().toISOString()}.json`;
        a.click();
        
        window.URL.revokeObjectURL(url);
    } catch (error) {
        console.error('å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
    }
}

// åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
function toggleAutoRefresh() {
    isAutoRefresh = !isAutoRefresh;
    const btn = document.querySelector('.toggle');
    
    if (isAutoRefresh) {
        btn.textContent = 'â¸ï¸ è‡ªåŠ¨åˆ·æ–°';
        btn.classList.add('active');
        startAutoRefresh();
    } else {
        btn.textContent = 'â–¶ï¸ è‡ªåŠ¨åˆ·æ–°';
        btn.classList.remove('active');
        stopAutoRefresh();
    }
}

// å¼€å§‹è‡ªåŠ¨åˆ·æ–°
function startAutoRefresh() {
    if (autoRefreshInterval) return;
    
    autoRefreshInterval = setInterval(() => {
        refreshStats();
    }, 5000); // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡
}

// åœæ­¢è‡ªåŠ¨åˆ·æ–°
function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    refreshStats();
    startAutoRefresh();
});

// é¡µé¢å¸è½½æ—¶æ¸…ç†
window.addEventListener('beforeunload', () => {
    stopAutoRefresh();
});
</script>
{% endblock %}
